# eBay Domain Policy - Optimized for Sold Listings Extraction
# Competition Killer Configuration

domain: ebay.com
description: eBay marketplace extraction policy optimized for sold prices
version: 2.0.0
priority: high

# Rendering Configuration (CRITICAL for eBay)
render:
  enabled: true
  mode: "stealth"  # Use stealth mode to avoid detection
  waitUntil: "networkidle"
  timeout: 30000  # 30s for complex pages
  scrollBehavior: "smooth"
  scrollDelay: 1000  # Wait for lazy-loaded content

# Rate Limiting (Be respectful)
rateLimit:
  requestsPerMinute: 30
  burstSize: 10
  backoffMs: 2000

# CSS Selectors for Sold Listings
selectors:
  # Search Results Page (Sold Listings)
  searchResults:
    container: ".s-item"
    title:
      - ".s-item__title"
      - "h3.s-item__title"
    price:
      - ".s-item__price"
      - ".s-item__detail--primary .s-item__price"
    soldDate:
      - ".s-item__title--tag"  # "Sold  Oct 15, 2024"
      - ".s-item__endedDate"
      - ".POSITIVE"
    shipping:
      - ".s-item__shipping"
      - ".s-item__freeXDays"
      - ".s-item__logisticsCost"
    condition:
      - ".SECONDARY_INFO"
      - ".s-item__subtitle"
    seller:
      - ".s-item__seller-info-text"
      - ".s-item__seller"
    image:
      - ".s-item__image-img"
      - "img.s-item__image-img"
    itemUrl:
      - ".s-item__link"
    bids:
      - ".s-item__bids"
      - ".s-item__bidCount"

  # Individual Listing Page
  itemPage:
    title:
      - "h1.x-item-title__mainTitle"
      - ".x-item-title"
      - "h1[itemprop='name']"
    price:
      - ".x-price-primary span.ux-textspans"
      - ".notranslate.x-price-primary"
      - "[itemprop='price']"
    soldInfo:
      - ".x-sold-info"
      - ".vi-bboxrev-postiontop"
    condition:
      - "[data-testid='x-item-condition-value']"
      - ".ux-labels-values__values-content"
    shipping:
      - ".ux-labels-values--shipping"
      - ".sh-del-cost"
    seller:
      - ".x-sellercard-atf__info__about-seller a"
      - ".mbg-nw"
    sellerRating:
      - ".x-sellercard-atf__data--rating"
    itemNumber:
      - "[data-testid='ux-item-number']"
    images:
      - ".ux-image-carousel-item img"
      - ".img-container img"

# URL Patterns
urlPatterns:
  # Sold listings search
  soldListings:
    pattern: "https://www.ebay.com/sch/i.html?.*LH_Sold=1.*"
    description: "Search results with sold items filter"

  # Individual item pages
  itemPage:
    pattern: "https://www.ebay.com/itm/\\d+"
    description: "Individual item listing page"

  # Completed listings
  completedListings:
    pattern: "https://www.ebay.com/sch/i.html?.*LH_Complete=1.*"
    description: "Search results with completed items filter"

# Extraction Configuration
extraction:
  maxNodes: 100
  prioritize:
    - "price"
    - "title"
    - "soldDate"
    - "condition"
    - "shipping"
  deduplication:
    enabled: true
    field: "itemNumber"

  # Data validation rules
  validation:
    price:
      required: true
      min: 0.01
      max: 1000000
    soldDate:
      format: "MMM DD, YYYY"
      required: false
    title:
      minLength: 5
      required: true

# Caching Configuration
caching:
  ttl: 3600  # 1 hour for sold listings
  enabled: true
  keyStrategy: "url-hash"

  # Cache invalidation rules
  invalidate:
    onPriceChange: false  # Sold prices don't change
    onDateExpiry: true
    afterDays: 30  # Keep sold data for 30 days

# Anti-Detection Measures
stealth:
  randomizeViewport: true
  randomizeUserAgent: true
  humanBehavior:
    enabled: true
    mouseMovements: true
    scrolling: true
    typingDelay:
      min: 50
      max: 150

  # Request headers
  headers:
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"
    "Accept-Language": "en-US,en;q=0.9"
    "Accept-Encoding": "gzip, deflate, br"
    "DNT": "1"
    "Connection": "keep-alive"
    "Upgrade-Insecure-Requests": "1"
    "Sec-Fetch-Dest": "document"
    "Sec-Fetch-Mode": "navigate"
    "Sec-Fetch-Site": "none"

# Error Handling
errorHandling:
  retryAttempts: 3
  retryDelay: 5000  # 5s between retries
  backoffMultiplier: 2

  # Specific error handling
  captcha:
    detectSelectors:
      - "#px-captcha"
      - ".g-recaptcha"
      - ".challenge-form"
    onDetect: "abort"  # Don't attempt to solve CAPTCHAs

  rateLimit:
    detectPatterns:
      - "429"
      - "Too Many Requests"
    onDetect: "backoff"  # Wait and retry

# Performance Optimization
performance:
  blockResources:
    - "image"  # Don't load images unless needed
    - "font"
    - "media"

  javascript:
    enabled: true  # Required for eBay
    timeout: 10000

# Data Post-Processing
postProcessing:
  # Parse prices correctly
  parsers:
    price:
      removeCurrency: true
      parseFloat: true
      removeCommas: true

    date:
      format: "ISO8601"
      timezone: "UTC"

    condition:
      normalize: true
      mapping:
        "New": "new"
        "New with tags": "new"
        "New without tags": "new"
        "Open box": "open_box"
        "Used": "used"
        "Refurbished": "refurbished"
        "For parts or not working": "parts"

# FlipIQ Integration Hints
flipiq:
  dataMapping:
    soldPrice: "price"
    soldDate: "soldDate"
    itemTitle: "title"
    itemCondition: "condition"
    shippingCost: "shipping"
    sellerName: "seller.name"
    sellerRating: "seller.rating"

  aggregations:
    - type: "average"
      field: "soldPrice"
      output: "averagePrice"

    - type: "median"
      field: "soldPrice"
      output: "medianPrice"

    - type: "count"
      output: "totalSoldItems"

    - type: "date_range"
      field: "soldDate"
      output: "timeRange"

# Monitoring
monitoring:
  logLevel: "info"
  trackMetrics:
    - "extractionTime"
    - "dataCompleteness"
    - "successRate"
    - "captchaRate"

  alerts:
    lowSuccessRate:
      threshold: 0.7
      action: "notify"

    highCaptchaRate:
      threshold: 0.1
      action: "throttle"
